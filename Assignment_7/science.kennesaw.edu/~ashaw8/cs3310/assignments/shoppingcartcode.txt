
        // Loads the submission details into session variables for each tab
        public void LoadSubmission(string name, int amount, FormCollection collection)
        {
            int off1 = 0, off2 = -1, off3 = 0, off4 = -3, value;
            string baseStr = collection["BasePrices"], nextPrice;
            string opStr = collection["OptionInfo"], nextOption, nextOption2;
            for (int i = 1; i <= amount; i++)
            {
                off1 = off2 + 1;
                off2 = baseStr.IndexOf(':', off1);
                nextPrice = baseStr.Substring(off1, off2 - off1);

                off3 = off4 + 3;
                off4 = opStr.IndexOf("###", off3);
                nextOption = opStr.Substring(off3, off4 - off3).Replace("@@@", ")<br />(");
                nextOption2 = opStr.Substring(off3, off4 - off3).Replace("@@@", ")%%% &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    (");
                if (nextOption == "")
                {
                    nextOption = "<br />";
                    nextOption2 = "";
                }
                else
                {
                    nextOption = "<br />" + Environment.NewLine + "</b><i>(" + nextOption + ")</i><b><br />";
                    nextOption2 = "%%% &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    (" + nextOption2 + ")";
                }

                if (!Int32.TryParse(collection[i - 1], out value))
                    continue;
                Session[String.Format("{0}Amount{1}", name, i)] = collection[i - 1];
                Session[String.Format("{0}Price{1}", name, i)] = Double.Parse(nextPrice) * value;
                Session[String.Format("{0}Option_{1}", name, i)] = nextOption;
                Session[String.Format("{0}Option2_{1}", name, i)] = nextOption2;
            }
        }

        // Converts table entries for a particular product type into a list of products for the website
        private List<ProductWithOption> loadViewTableData(string pType, int viewIndex)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                List<ProductWithOption> productList = new List<ProductWithOption>();
                ProductWithOption pItem;

                ViewData["BasePrices"] = "";
                ViewData["OptionInfo"] = "";
                ViewData["InitScripts"] = "";
                var productItems = from wp in db1.Products where (wp.ProductType == pType) select wp;
                int index = 1;
                int listCount = 0;
                foreach (var p in productItems)
                {
                    string pathlabel = "";
                    Session[pType + "ProductID" + index] = p.ProductID;
                    Session[pType + "ProductName" + index] = "";
                    if (String.IsNullOrWhiteSpace(p.ProductName) && String.IsNullOrWhiteSpace(p.ImageFile))
                        pathlabel = "[No Image]";
                    else
                    {
                        if (!String.IsNullOrWhiteSpace(p.ProductName))
                        {
                            pathlabel = p.ProductName.Trim();
                            Session[pType + "ProductName" + index] = pathlabel;
                            if (!String.IsNullOrWhiteSpace(p.ImageFile))
                                pathlabel += ":<br />";
                        }
                        if (!String.IsNullOrWhiteSpace(p.ImageFile))
                            pathlabel += "<img src=\"/Content/" + p.ImageFile.Trim() + "\" alt=\"Store Product Image\" />";
                    }
                    Session[pType + "Path" + index] = pathlabel;
                    Session[pType + "UnitPrice" + index] = p.UnitPrice;
                    ViewData["BasePrices"] += p.UnitPrice + ":";
                    ViewData["OptionInfo"] += "###";
                    if (Session[pType + "Amount" + index] == null)
                        ViewData["DefaultChoice" + index] = (p.DefaultAmount >= 0) ? p.DefaultAmount : 0;
                    else
                        ViewData["DefaultChoice" + index] = Int32.Parse(Session[pType + "Amount" + index].ToString());
                    ++index;

                    pItem = new ProductWithOption();
                    pItem.ProductID = p.ProductID;
                    pItem.ProductType = p.ProductType;
                    pItem.ProductName = p.ProductName;
                    pItem.ImageFile = p.ImageFile;
                    pItem.UnitPrice = p.UnitPrice;
                    pItem.MaxAmount = p.MaxAmount;
                    pItem.DefaultAmount = p.DefaultAmount;

                    ArrayList keylist = new ArrayList();
                    SortedList optionslist = new SortedList();
                    using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
                    {
                        var prodMatches = from x in db3.Intersections where (x.ProductID == p.ProductID) select x;
                        foreach (var m in prodMatches)
                        {
                            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
                            {
                                var optMatches = from y in db2.Options where (y.OptionID == m.OptionID) select y;
                                foreach (var n in optMatches)
                                {
                                    if (!keylist.Contains(n.OptionType))
                                    {
                                        keylist.Add(n.OptionType);
                                        ArrayList typeList = new ArrayList();
                                        if (n.OptionCost < 0)
                                            typeList.Add(n.OptionName + ": - $" + (-n.OptionCost) + "###" + n.OptionCost);
                                        else
                                            typeList.Add(n.OptionName + ": + $" + n.OptionCost + "###" + n.OptionCost);
                                        optionslist.Add(n.OptionType, typeList);
                                    }
                                    else
                                    {
                                        ArrayList typeList = (ArrayList)optionslist.GetByIndex(
                                                                         optionslist.IndexOfKey(n.OptionType));
                                        if (n.OptionCost < 0)
                                            typeList.Add(n.OptionName + ": - $" + (-n.OptionCost) + "###" + n.OptionCost);
                                        else
                                            typeList.Add(n.OptionName + ": + $" + n.OptionCost + "###" + n.OptionCost);
                                    }
                                }
                            }
                        }
                    }
                    pItem.ColumnLabel = optionsColumnHeading[viewIndex];
                    pItem.TableString = "";

                    ArrayList pickedlist = GetPickedOptions(pType, index - 1);

                    int count1 = 0;
                    int count3 = 1;
                    foreach (var key in keylist)
                    {
                        ArrayList typeList = (ArrayList)optionslist.GetByIndex(optionslist.IndexOfKey(key));
                        int count2 = 0;
                        foreach (var value in typeList)
                        {
                            if (count1 == 0)
                            {
                                pItem.TableString += "<table class=\"bdrless\" >" + Environment.NewLine;
                            }
                            if (count2 == 0)
                            {
                                pItem.TableString += "<tr><td align=\"right\"><b>" + key + "</b>: </td><td>";
                                pItem.TableString += "<select id=\"chg_" + (index - 1) + "_" + count3 +
                                                    "\" onchange=\"changePrice(" + (index - 1) + "," +
                                                    "this.value," + p.UnitPrice + ")\">" +
                                                    "<option value=\"\">-- Click To Select --</option>" +
                                                    Environment.NewLine;
                            }
                            int n = value.ToString().IndexOf("###");
                            string val1 = value.ToString().Substring(0, n);
                            string val2 = value.ToString().Substring(n + 3);
                            string selectedstr = "";
                            int pos = 0;
                            foreach (var pickedval in pickedlist)
                            {
                                if (pickedval.ToString() == val1)
                                {
                                    selectedstr = " selected";
                                    ViewData["InitScripts"] += "<script type=\"text/javascript\">" + Environment.NewLine;
                                    ViewData["InitScripts"] += "changePrice(" + (index - 1) + "," + val2 +
                                                             "," + p.UnitPrice + ");" + Environment.NewLine;
                                    ViewData["InitScripts"] += "</script>" + Environment.NewLine;
                                    break;
                                }
                                ++pos;
                            }
                            if (selectedstr != "")
                                pickedlist.Remove(pos);
                            pItem.TableString += "<option" + selectedstr + " value=\"" + val2 + "\">" +
                                                    val1 + "</option>" + Environment.NewLine;
                            ++listCount;
                            ++count1;
                            ++count2;
                        }
                        ++count3;
                        if (count2 > 0)
                            pItem.TableString += "</select></td></tr>" + Environment.NewLine;
                    }
                    if (count1 > 0)
                        pItem.TableString += "</table>" + Environment.NewLine;
                    productList.Add(pItem);
                }
                Session[pType + "ItemAmount"] = productItems.Count();

                if (listCount == 0)
                    foreach (var product in productList)
                    {
                        product.ColumnLabel = "";
                        product.TableString = "";
                    }

                return productList.ToList();
            }
        }

        // Builds a string that is an HTML lists of all of the products purchased
        private string GetSessionItemString(string name, string title, int amount, ref decimal total)
        {
            string ItemStr = "", OptionStr;
            for (int i = 1; i <= amount; i++)
                if (!string.IsNullOrEmpty((string)Session[String.Format("{0}Amount{1}", name, i)]) &&
                              (string)Session[String.Format("{0}Amount{1}", name, i)] != "0")
                {
                    ItemStr += "<tr><td align=\"center\"><b>" +
                                      String.Format("{0} {1}", Session[name + "Amount" + i], title);
                    if ((string)Session[String.Format("{0}Amount{1}", name, i)] != "1")
                        ItemStr += "s";


                    if (Session[String.Format("{0}ProductName{1}", name, i)] != null &&
                           !string.IsNullOrEmpty((string)Session[String.Format("{0}ProductName{1}", name, i)]))
                        ItemStr += String.Format(":<br /><span style=\"color: #8A2BE2;\" color=\"#8A2BE2\"><i>{0}</i></span>",
                                                 (string)Session[String.Format("{0}ProductName{1}", name, i)]);
                    else
                        //ItemStr += String.Format("<br />(Option {0})", i);
                        ItemStr += String.Format("<br />(Item {0})", i);

                    OptionStr = (string)Session[String.Format("{0}Option_{1}", name, i)];
                    ItemStr += String.Format("{0}Total: ", OptionStr);
                    ItemStr += String.Format("{0:C}", Session[String.Format("{0}Price{1}", name, i)]);
                    ItemStr += "</b></td>" + Environment.NewLine;
                    ItemStr += "<td align=\"center\"><b><i>" + Session[String.Format("{0}Path{1}", name, i)];
                    ItemStr += "</i></b></td></tr>" + Environment.NewLine;
                    total += Convert.ToDecimal(Session[String.Format("{0}Price{1}", name, i)]);
                }
            return ItemStr;
        }

        // Builds a string that is an text lists of all of the products purchased
        public string GetSessionItemString2(string name, string title, int amount, ref decimal total, string prevStr)
        {
            string ItemStr = "", OptionStr;
            for (int i = 1; i <= amount; i++)
                if (!string.IsNullOrEmpty((string)Session[String.Format("{0}Amount{1}", name, i)]) &&
                     (string)Session[String.Format("{0}Amount{1}", name, i)] != "0")
                {
                    if (!string.IsNullOrEmpty(ItemStr))
                        ItemStr += "%%%";
                    ItemStr += String.Format("{0} {1}", Session[String.Format("{0}Amount{1}", name, i)], title);
                    if ((string)Session[String.Format("{0}Amount{1}", name, i)] != "1")
                        ItemStr += "s";
                    if (Session[String.Format("{0}ProductName{1}", name, i)] != null &&
                           !string.IsNullOrEmpty((string)Session[String.Format("{0}ProductName{1}", name, i)]))
                        ItemStr += String.Format(" ({0}) for ",
                                                 (string)Session[String.Format("{0}ProductName{1}", name, i)]);
                    else
                        //ItemStr += String.Format(" (Option {0}) for ", i);
                        ItemStr += String.Format(" (Item {0}) for ", i);
                    ItemStr += String.Format("{0:C}", Session[String.Format("{0}Price{1}", name, i)]);
                    total += Convert.ToDecimal(Session[String.Format("{0}Price{1}", name, i)]);

                    OptionStr = (string)Session[String.Format("{0}Option2_{1}", name, i)];
                    if (OptionStr != "")
                        ItemStr += OptionStr;
                }
            if (!string.IsNullOrEmpty(ItemStr) & !string.IsNullOrEmpty(prevStr))
                ItemStr = "%%%" + ItemStr;
            return ItemStr;
        }

        // Method for getting an ArrayList of the options picked by the user
        private ArrayList GetPickedOptions(string pType, int index)
        {
            ArrayList pickedlist = new ArrayList();
            if (Session[pType + "Option_" + index] != null)
            {
                string optstr = Session[pType + "Option_" + index].ToString();
                for (int i = 0, j = 0; i < optstr.Length; ++i)
                {
                    if ((i = optstr.IndexOf(">(", i)) == -1)
                        break;
                    if ((j = optstr.IndexOf(")<", i)) == -1)
                        j = optstr.Length;
                    pickedlist.Add(optstr.Substring(i + 2, j - i - 2));
                    i = j;
                }
            }
            return pickedlist;
        }

        // Method for getting a product Name from a ProductID
        private string GetProductName(int productID)
        {
            string name = "";
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                var result = from p in db1.Products where (p.ProductID == productID) select p;
                if (result.Count() == 0)
                    return "[No Name]";
                Product product = result.FirstOrDefault();
                for (int i = 1; i < tabViews.Length; ++i)
                    if (tabViews[i] == product.ProductType)
                    {
                        name = tabHeadings[i].Trim();
                        break;
                    }
                if (!string.IsNullOrEmpty(product.ProductName))
                {
                    if (name.Length > 0)
                        name += ": ";
                    return (name + product.ProductName.Trim());
                }
                result = from p in db1.Products where (p.ProductType == product.ProductType) select p;
                int cnt = 0;
                foreach (Product p in result)
                {
                    if (p.ProductType == product.ProductType)
                        break;
                    ++cnt;
                }
                if (cnt < result.Count())
                    return (name + " (Item " + (cnt+1) + ")");
                return name;
            }
        }

        // Action Method for Checkout View
        public ActionResult CheckOut()
        {
            ViewData["Message"] = "Checking Out - The following items are in your Shopping Cart:";

            string ItemList = "";
            decimal SubTotalPrice = 0.0M;
            for (int i = 0; i < tabViews.Length; ++i)
                if (Session[tabViews[i] + "ItemAmount"] != null)
                {
                    int amount = Int32.Parse(Session[tabViews[i] + "ItemAmount"].ToString());
                    ItemList += GetSessionItemString(tabViews[i], tabHeadings[i], amount, ref SubTotalPrice);
                }

            ViewData["HasItems"] = false;
            if (string.IsNullOrEmpty(ItemList))
                ItemList += "<pre style=\"font-size: 16px;\"><b>  [ Nothing Was Purchased ]</b></pre>";
            else
            {
                ItemList = "<table>" + ItemList + "</table>";
                ItemList += "<p></p><style type=\"text/css\">";
                ItemList += "table.summary { border-width: 0px; }";
                ItemList += "table.summary td { border-width: 0px; font-size: 16px; ";
                ItemList += "padding: 3px; font-weight:bold; text-align:right; }";
                ItemList += "</style><table class=\"summary\">";
                ItemList += "<tr><td>SubTotal:</td><td width=\"30\"></td><td>";
                ItemList += String.Format("{0:0.00}", SubTotalPrice);
                ItemList += "</td></tr><tr><td>Tax:</td><td></td><td>";
                ItemList += String.Format("{0:0.00}", decimal.Round(SubTotalPrice*taxRate,2));
                ItemList += "</td></tr><tr><td>Total Purchase Price:</td><td></td><td>";
                ItemList += String.Format("{0:C}", SubTotalPrice + decimal.Round(SubTotalPrice*taxRate,2));
                ItemList += "</td></tr>";
                ItemList += "</table>";
                ViewData["HasItems"] = true;
            }
            ViewData["Message2"] = ItemList;

            return View();
        }

        // Action Method for getting Customers billing (registration) information
        public ActionResult ShoppingCartAccount()
        {
            ViewData["Message"] = "Please Fill In Your Billing Information";
            ViewData["Message"] += " (entries with * are required):";
            return View();
        }

        // Action Method for getting Customers billing (registration) information
        [HttpPost]
        public ActionResult ShoppingCartAccount(Customer accountToCreate)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    ViewData["Message"] = "Please correct the following error(s):";
                    return View();
                }

                string ItemList = "";
                decimal SubTotalPrice = 0.0M;
                for (int i = 0; i < tabViews.Length; ++i)
                    if (Session[tabViews[i] + "ItemAmount"] != null)
                    {
                        int amount = Int32.Parse(Session[tabViews[i] + "ItemAmount"].ToString());
                        ItemList += GetSessionItemString2(tabViews[i], tabHeadings[i], amount, ref SubTotalPrice, ItemList);
                    }
                ItemList += String.Format("%%%%%%<h3>SubTotal: {0:C}", SubTotalPrice);
                ItemList += String.Format("%%%Tax: {0:C}", decimal.Round(SubTotalPrice*taxRate,2));
                ItemList += String.Format("%%%Total Purchase Price: {0:C}</h3>", SubTotalPrice + 
                                                           decimal.Round(SubTotalPrice*taxRate,2));

                Session["Name"] = String.Format("{0} {1}", accountToCreate.Firstname, accountToCreate.Lastname);
                Session["Email"] = accountToCreate.Email;
                Session["ItemList"] = ItemList;

                using (ShoppingCartDBEntities db = new ShoppingCartDBEntities())
                {
                    db.AddToCustomers(accountToCreate);
                    db.SaveChanges();

                    using (ShoppingCartDBEntities4 db4 = new ShoppingCartDBEntities4())
                    {
                        PurchaseOrder order = new PurchaseOrder();
                        order.CustomerID = accountToCreate.ID;
                        order.Date = DateTime.Now;
                        order.SubTotal = SubTotalPrice;
                        order.Tax = decimal.Round(SubTotalPrice*taxRate,2);
                        order.Total = order.SubTotal + order.Tax;

                        db4.AddToPurchaseOrders(order);
                        db4.SaveChanges();
                        
                        int linenum = 0;
                        for (int i = 0; i < tabViews.Length; ++i)
                            if (Session[tabViews[i] + "ItemAmount"] != null)
                            {
                                int amount = Int32.Parse(Session[tabViews[i] + "ItemAmount"].ToString());
                                for (int j = 1; j <= amount; j++)
                                {
                                    string quantityStr = (string)Session[tabViews[i] + "Amount" + j];
                                    if (!string.IsNullOrEmpty(quantityStr) && quantityStr != "0" &&
                                                 Session[tabViews[i] + "ProductID" + j] != null &&
                                                        Session[tabViews[i] + "Price" + j] != null)
                                        using (ShoppingCartDBEntities5 db5 = new ShoppingCartDBEntities5())
                                        {
                                            int pid = Int32.Parse(Session[tabViews[i] + "ProductID" + j].ToString());
                                            decimal price = Decimal.Parse(Session[tabViews[i] + "Price" + j].ToString());

                                            LineItem item = new LineItem();
                                            item.OrderID = order.OrderID;
                                            item.LineNumber = ++linenum;
                                            item.ProductID = pid;
                                            item.Quantity = Int32.Parse(quantityStr);
                                            item.ExtendedPrice = price;

                                            db5.AddToLineItems(item);
                                            db5.SaveChanges();

                                            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
                                            {
                                                ArrayList pickedlist = GetPickedOptions(tabViews[i], j);
                                                var ilist = from o in db3.Intersections where (o.ProductID == pid) select o;

                                                foreach (var pickedval in pickedlist)
                                                    foreach (var ival in ilist)
                                                    {
                                                        string optionStr = "";
                                                        using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
                                                        {
                                                            Option opt = db2.Options.First(o => o.OptionID == ival.OptionID);
                                                            if (opt.OptionCost < 0)
                                                                optionStr = opt.OptionName + ": - $" + (-opt.OptionCost);
                                                            else
                                                                optionStr = opt.OptionName + ": + $" + (opt.OptionCost);
                                                        }
                                                        if (pickedval.ToString() == optionStr)
                                                        {
                                                            using (ShoppingCartDBEntities6 db6 = new ShoppingCartDBEntities6())
                                                            {
                                                                OptionAssociation oa = new OptionAssociation();
                                                                oa.OrderID = order.OrderID;
                                                                oa.ProductID = pid;
                                                                oa.OptionID = ival.OptionID;

                                                                db6.AddToOptionAssociations(oa);
                                                                db6.SaveChanges();
                                                            }
                                                            break;
                                                        }
                                                    }
                                            }
                                        }
                                }
                            }
                    }
                }

                for (int i = 0; i < tabViews.Length; ++i)
                    if (Session[tabViews[i] + "ItemAmount"] != null)
                    {
                        int amount = Int32.Parse(Session[tabViews[i] + "ItemAmount"].ToString());
                        for (int j = 1; j <= amount; ++j)
                        {
                            Session[tabViews[i] + "Amount" + j] = "0";
                            Session[tabViews[i] + "Price" + j] = 0.0;
                            Session[tabViews[i] + "Option_" + j] = "";
                            Session[tabViews[i] + "Option2_" + j] = "";
                        }
                    }

                return RedirectToAction("ConfirmPurchase");
            }
            catch (Exception ex)
            {
                ViewData["Message"] = "Error processing data: " + GetError(ex);
                return View();
            }
        }

        // Action Method for confirming the Customer's purchases
        public ActionResult ConfirmPurchase()
        {
            ViewData["Message"] = "Thanks for making your purchase with " + siteHeading + "!";
            ViewData["Message2"] = "Your items are being shipped, and an email has been sent<br />";
            ViewData["Message2"] += "with the following order details for your records:<p></p><hr /><p></p>";
            ViewData["Message2"] += Session["ItemList"].ToString().Replace("%%%", "<br />");
            ViewData["Message2"] += "<p></p><hr />";

            MailMessage message = new MailMessage();
            message.From = new MailAddress(websiteEmail);
            message.To.Add(new MailAddress(Session["Email"].ToString()));
            message.Subject = "Store Purchase Confirmation";
            message.IsBodyHtml = false;
            message.Body = String.Format("Hi {0},{1}{1}", Session["Name"], Environment.NewLine);
            message.Body += "The following order was received, and will be shipped shortly:";
            message.Body += Environment.NewLine + Environment.NewLine;
            message.Body += Session["ItemList"].ToString().Replace("%%%", Environment.NewLine)
                                              .Replace("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", "")
                                              .Replace("<h3>", "").Replace("</h3>", "");

            SmtpClient client = new SmtpClient();
            client.Host = "208.73.222.114";
            client.Port = 7301;
            client.Send(message);

            return View();
        }

        // Action Method for providing admin functions
        [Authorize]
        public ActionResult Admin()
        {
            ViewData["Message"] = "Website Administration:";
            return View();
        }

        // Admin view for listing all Customer Accounts
        [Authorize]
        public ActionResult Customers(string sortOrder)
        {
            using (ShoppingCartDBEntities db = new ShoppingCartDBEntities())
            {
                ViewData["Message"] = "Customer Accounts:";

                ViewData["LastNameSortParm"] = String.IsNullOrEmpty(sortOrder) ? "LastName desc" : "";
                ViewData["FirstNameSortParm"] = (sortOrder == "FirstName" ? "FirstName desc" : "FirstName");
                ViewData["IDSortParm"] = (sortOrder == "ID" ? "ID desc" : "ID");
                ViewData["AmountSortParm"] = (sortOrder == "Amount" ? "Amount desc" : "Amount");

                var accounts = from a in db.Customers select a;

                List<CustomerWithPurchase> customerList = new List<CustomerWithPurchase>();
                foreach (var acc in accounts)
                {
                    using (ShoppingCartDBEntities4 db4 = new ShoppingCartDBEntities4())
                    {
                        CustomerWithPurchase customer = new CustomerWithPurchase();
                        try
                        {
                            PurchaseOrder order = db4.PurchaseOrders.First(o => o.CustomerID == acc.ID);
                            customer.TotalPrice = order.Total;
                            customer.OrderID = order.OrderID;
                        }
                        catch (Exception)
                        {
                            customer.TotalPrice = 0M;
                            customer.OrderID = -1;
                        }
                        customer.ID = acc.ID;
                        customer.Firstname = acc.Firstname;
                        customer.Lastname = acc.Lastname;
                        customerList.Add(customer);
                    }
                }

                switch (sortOrder)
                {
                    case "FirstName":
                        customerList = customerList.OrderBy(s => s.Firstname).ToList();
                        break;
                    case "FirstName desc":
                        customerList = customerList.OrderByDescending(s => s.Firstname).ToList();
                        break;
                    case "ID":
                        customerList = customerList.OrderBy(s => s.ID).ToList();
                        break;
                    case "ID desc":
                        customerList = customerList.OrderByDescending(s => s.ID).ToList();
                        break;
                    case "Amount":
                        customerList = customerList.OrderBy(s => s.ID).ToList();
                        break;
                    case "Amount desc":
                        customerList = customerList.OrderByDescending(s => s.ID).ToList();
                        break;
                    case "LastName desc":
                        customerList = customerList.OrderByDescending(s => s.Lastname).ToList();
                        break;
                    default:
                        customerList = customerList.OrderBy(s => s.Lastname).ToList();
                        break;
                }

                return View(customerList.ToList());
            }
        }

        // Admin view for reviewing a Customer Account
        [Authorize]
        public ActionResult CustomerDetails(int ID)
        {
            using (ShoppingCartDBEntities db = new ShoppingCartDBEntities())
            {
                ViewData["Message"] = "Customer Account Details:";
                try
                {
                    Customer theAccount = db.Customers.First(p => p.ID == ID);
                    return View(theAccount);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing a Customer Account
        [Authorize]
        public ActionResult EditCustomer(int ID)
        {
            using (ShoppingCartDBEntities db = new ShoppingCartDBEntities())
            {
                ViewData["Message"] = "Edit Customer Account:";
                try
                {
                    Customer theAccount = db.Customers.First(p => p.ID == ID);
                    return View(theAccount);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing a Customer Account
        [HttpPost, Authorize]
        public ActionResult EditCustomer(Customer account)
        {
            using (ShoppingCartDBEntities db = new ShoppingCartDBEntities())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error editing account:";
                        return View("EditCustomer", account);
                    }

                    Customer theAccount = db.Customers.First(p => p.ID == account.ID);

                    theAccount.Firstname = account.Firstname;
                    theAccount.Lastname = account.Lastname;
                    theAccount.StreetAddress = account.StreetAddress;
                    theAccount.City = account.City;
                    theAccount.State = account.State;
                    theAccount.Zip = account.Zip;
                    theAccount.Phone = account.Phone;
                    theAccount.Email = account.Email;
                    db.SaveChanges();

                    return RedirectToAction("Customers");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error editing account: " + GetError(ex);
                    return View("EditCustomer", account);
                }
            }
        }

        // Action view for listing all Purchase Orders
        [Authorize]
        public ActionResult Purchases(string sortOrder)
        {
            using (ShoppingCartDBEntities4 db4 = new ShoppingCartDBEntities4())
            {
                ViewData["Message"] = "Purchase Orders:";

                ViewData["OrderIDSortParm"] = String.IsNullOrEmpty(sortOrder) ? "OrderID desc" : "";
                ViewData["CustomerIDSortParm"] = (sortOrder == "CustomerID" ? "CustomerID desc" : "CustomerID");
                ViewData["DateSortParm"] = (sortOrder == "DateID" ? "DateID desc" : "DateID");
                ViewData["TotalSortParm"] = (sortOrder == "Total" ? "Total desc" : "Total");
                
                var orders = from p in db4.PurchaseOrders select p;

                switch (sortOrder)
                {
                    case "CustomerID":
                        orders = orders.OrderBy(s => s.CustomerID);
                        break;
                    case "CustomerID desc":
                        orders = orders.OrderByDescending(s => s.CustomerID);
                        break;
                    case "DateID":
                        orders = orders.OrderBy(s => s.Date);
                        break;
                    case "DateID desc":
                        orders = orders.OrderByDescending(s => s.Date);
                        break;
                    case "Total":
                        orders = orders.OrderBy(s => s.Total);
                        break;
                    case "Total desc":
                        orders = orders.OrderByDescending(s => s.Total);
                        break;
                    case "OrderID desc":
                        orders = orders.OrderByDescending(s => s.OrderID);
                        break;
                    default:
                        orders = orders.OrderBy(s => s.OrderID);
                        break;
                }

                return View(orders.ToList());
            }
        }

        // Admin view for reviewing a Purchase Order
        [Authorize]
        public ActionResult OrderDetails(int ID)
        {
            using (ShoppingCartDBEntities4 db4 = new ShoppingCartDBEntities4())
            {
                ViewData["Message"] = "Purchase Order Details:";
                try
                {
                    PurchaseOrder order = db4.PurchaseOrders.First(p => p.OrderID == ID);

                    PurchaseOrderWithDetails theOrder = new PurchaseOrderWithDetails();
                    theOrder.OrderID = order.OrderID;
                    theOrder.CustomerID = order.CustomerID;
                    theOrder.Date = order.Date;
                    theOrder.SubTotal = order.SubTotal;
                    theOrder.Tax = order.Tax;
                    theOrder.Total = order.Total;
                    theOrder.Details = "";

                    using (ShoppingCartDBEntities5 db5 = new ShoppingCartDBEntities5())
                    {
                        String details = "";
                        for (int lineNum = 1; ; lineNum++)
                        {
                            var result = from x in db5.LineItems
                                                 where (x.OrderID == ID && x.LineNumber == lineNum)
                                                 select x;
                            if (result.Count() == 0)
                                break;
                            LineItem item = result.FirstOrDefault();

                            string optDetails = "";
                            using (ShoppingCartDBEntities6 db6 = new ShoppingCartDBEntities6())
                            {
                                var result2 = from x in db6.OptionAssociations
                                              where (x.OrderID == ID && x.ProductID == item.ProductID)
                                              select x;
                                string optstrs = "";
                                foreach (var oa in result2)
                                {
                                    using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
                                    {
                                        Option opt = db2.Options.First(o => o.OptionID == oa.OptionID);
                                        if (opt.OptionCost < 0)
                                            optstrs = opt.OptionName + ", - $" + (-opt.OptionCost);
                                        else
                                            optstrs = opt.OptionName + ", $" + (opt.OptionCost);
                                        optDetails += "<br /><i>(Option: " + optstrs + ")</i>";
                                    }
                                }
                            }


                            details += "<tr><td align=\"center\">" + lineNum + "</td>" +
                                       "<td align=\"center\">" +
                                       "<a href=\"/Home/ProductDetails/" + item.ProductID + "\">" + 
                                       GetProductName(item.ProductID) + "</a>" + optDetails + "</td>" +
                                       "<td align=\"center\">" + item.Quantity + "</td>" +
                                       "<td align=\"center\">" + item.ExtendedPrice + "</td></tr>";
                        }
                        if (details.Trim().Length > 0)
                        {
                            details = "<p></p>Line Items:<p></p><table><tr>" +
                                "<td align=\"center\">" +
                                "<span style=\"color: #0000FF;\" color=\"#0000FF\"><b>Line</b></span></td>" +
                                "<td align=\"center\">" +
                                "<span style=\"color: #0000FF;\" color=\"#0000FF\"><b>Name and Options</b></span></td>" +
                                "<td align=\"center\">" +
                                "<span style=\"color: #0000FF;\" color=\"#0000FF\"><b>Quantity</b></span></td>" +
                                "<td align=\"center\">" +
                                "<span style=\"color: #0000FF;\" color=\"#0000FF\"><b>Extended Price</b></span></td></tr>" +
                                             details + "</table>";
                        }
                        theOrder.Details = details;
                    }

                    return View(theOrder);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for listing all Products
        [Authorize]
        public ActionResult Products(string sortOrder)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                ViewData["Message"] = "Products Table:";

                ViewData["IDSortParm"] = String.IsNullOrEmpty(sortOrder) ? "ID desc" : "";
                ViewData["TypeSortParm"] = (sortOrder == "Type" ? "Type desc" : "Type");
                ViewData["NameSortParm"] = (sortOrder == "Name" ? "Name desc" : "Name");
                ViewData["ImageSortParm"] = (sortOrder == "Image" ? "Image desc" : "Image");
                ViewData["PriceSortParm"] = (sortOrder == "Price" ? "Price desc" : "Price");

                var productls = from p in db1.Products select p;

                switch (sortOrder)
                {
                    case "Type":
                        productls = productls.OrderBy(p => p.ProductType);
                        break;
                    case "Type desc":
                        productls = productls.OrderByDescending(p => p.ProductType);
                        break;
                    case "Name":
                        productls = productls.OrderBy(p => p.ProductName);
                        break;
                    case "Name desc":
                        productls = productls.OrderByDescending(p => p.ProductName);
                        break;
                    case "Image":
                        productls = productls.OrderBy(p => p.ImageFile);
                        break;
                    case "Image desc":
                        productls = productls.OrderByDescending(p => p.ImageFile);
                        break;
                    case "Price":
                        productls = productls.OrderBy(p => p.UnitPrice);
                        break;
                    case "Price desc":
                        productls = productls.OrderByDescending(p => p.UnitPrice);
                        break;
                    case "ID desc":
                        productls = productls.OrderByDescending(p => p.ProductID);
                        break;
                    default:
                        productls = productls.OrderBy(p => p.ProductID);
                        break;
                }
                return View(productls.ToList());

            }
        }

        // Admin view for reviewing a Product
        [Authorize]
        public ActionResult ProductDetails(int ID)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                ViewData["Message"] = "Product Details:";
                try
                {
                    Product product = db1.Products.First(p => p.ProductID == ID);
                    return View(product);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing a Product
        [Authorize]
        public ActionResult EditProduct(int ID)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                ViewData["Message"] = "Product:";
                try
                {
                    Product product = db1.Products.First(p => p.ProductID == ID);
                    return View(product);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing a Product
        [HttpPost, Authorize]
        public ActionResult EditProduct(Product product, HttpPostedFileBase FileUpload)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error editing product:";
                        return View("EditProduct", product);
                    }

                    Boolean gotError = false;
                    String message = GetFileUpload(FileUpload, ref gotError);
                    if (gotError)
                    {
                        ViewData["Message"] = "Upload Error: " + message;
                        return View("EditProduct", product);
                    }

                    Product theProduct = db1.Products.First(p => p.ProductID == product.ProductID);

                    theProduct.ProductType = product.ProductType;
                    theProduct.ProductName = product.ProductName;
                    theProduct.ImageFile = product.ImageFile;
                    theProduct.UnitPrice = product.UnitPrice;
                    theProduct.MaxAmount = product.MaxAmount;
                    theProduct.DefaultAmount = product.DefaultAmount;
                    db1.SaveChanges();

                    return RedirectToAction("Products");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error editing product: " + GetError(ex);
                    return View("EditProduct", product);
                }
            }
        }

        // Admin view for creating a new Product
        [Authorize]
        public ActionResult CreateProduct()
        {
            ViewData["Message"] = "New Product:";
            Product product = new Product();
            return View(product);
        }

        // Admin view for creating a new Product
        [HttpPost, Authorize]
        public ActionResult CreateProduct(Product product, HttpPostedFileBase FileUpload)
        {
            ViewData["Message"] = "New Product:";
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error Creating Product:";
                        return View("CreateProduct", product);
                    }

                    Boolean gotError = false;
                    String message = GetFileUpload(FileUpload, ref gotError);
                    if (gotError)
                    {
                        ViewData["Message"] = "Upload Error: " + message;
                        return View("CreateProduct", product);
                    }

                    db1.AddToProducts(product);
                    db1.SaveChanges();

                    return RedirectToAction("Products");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Creating Product: " + GetError(ex);
                    return View("CreateProduct", product);
                }
            }
        }

        // Admin view for deleting a Product
        [Authorize]
        public ActionResult DeleteProduct(int ID)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                ViewData["Message"] = "Are You Sure You Want To Delete The Following Product?";
                try
                {
                    Product product = db1.Products.First(p => p.ProductID == ID);
                    return View(product);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for deleting a Product
        [HttpPost, Authorize]
        public ActionResult DeleteProduct(Product product)
        {
            using (ShoppingCartDBEntities1 db1 = new ShoppingCartDBEntities1())
            {
                try
                {
                    if (product == null)
                        return RedirectToAction("Error");

                    Product theProduct = db1.Products.First(p => p.ProductID == product.ProductID);
                    db1.DeleteObject(theProduct);
                    db1.SaveChanges();

                    return RedirectToAction("Products");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Deleting Product: " + GetError(ex);
                    return View("DeleteProduct", product);
                }
            }
        }

        // Admin view for listing all Options
        [Authorize]
        public ActionResult Options(string sortOrder)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                ViewData["Message"] = "Options Table:";

                ViewData["IDSortParm"] = String.IsNullOrEmpty(sortOrder) ? "ID desc" : "";
                ViewData["TypeSortParm"] = (sortOrder == "Type" ? "Type desc" : "Type");
                ViewData["NameSortParm"] = (sortOrder == "Name" ? "Name desc" : "Name");
                ViewData["PriceSortParm"] = (sortOrder == "Price" ? "Price desc" : "Price");

                var optionls = from o in db2.Options select o;

                switch (sortOrder)
                {
                    case "Type":
                        optionls = optionls.OrderBy(o => o.OptionType);
                        break;
                    case "Type desc":
                        optionls = optionls.OrderByDescending(o => o.OptionType);
                        break;
                    case "Name":
                        optionls = optionls.OrderBy(o => o.OptionName);
                        break;
                    case "Name desc":
                        optionls = optionls.OrderByDescending(o => o.OptionName);
                        break;
                    case "Price":
                        optionls = optionls.OrderBy(o => o.OptionCost);
                        break;
                    case "Price desc":
                        optionls = optionls.OrderByDescending(o => o.OptionCost);
                        break;
                    case "ID desc":
                        optionls = optionls.OrderByDescending(o => o.OptionID);
                        break;
                    default:
                        optionls = optionls.OrderBy(o => o.OptionID);
                        break;
                }
                return View(optionls.ToList());
            }
        }

        // Admin view for reviewing an Option
        [Authorize]
        public ActionResult OptionDetails(int ID)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                ViewData["Message"] = "Option Details:";
                try
                {
                    Option option = db2.Options.First(o => o.OptionID == ID);
                    return View(option);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing an Option
        [Authorize]
        public ActionResult EditOption(int ID)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                ViewData["Message"] = "Option:";
                try {
                
                    Option option = db2.Options.First(o => o.OptionID == ID);
                    return View(option);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for editing an Option
        [HttpPost, Authorize]
        public ActionResult EditOption(Option option)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error Editing Option:";
                        return View("EditOption", option);
                    }

                    Option theOption = db2.Options.First(o => o.OptionID == option.OptionID);

                    theOption.OptionType = option.OptionType;
                    theOption.OptionName = option.OptionName;
                    theOption.OptionCost = option.OptionCost;
                    db2.SaveChanges();

                    return RedirectToAction("Options");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Editing Option: " + GetError(ex);
                    return View("EditOption", option);
                }
            }
        }

        // Admin view for creating a new Option
        [Authorize]
        public ActionResult CreateOption()
        {
            ViewData["Message"] = "New Option:";
            Option option = new Option();
            return View(option);
        }

        // Admin view for creating a new Option
        [HttpPost, Authorize]
        public ActionResult CreateOption(Option option)
        {
            ViewData["Message"] = "New Option:";
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error Creating Option:";
                        return View("CreateOption", option); ;
                    }

                    db2.AddToOptions(option);
                    db2.SaveChanges();

                    return RedirectToAction("Options");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Creating Option: " + GetError(ex);
                    return View("CreateOption", option); ;
                }
            }
        }

        // Admin view for deleting a Option
        [Authorize]
        public ActionResult DeleteOption(int ID)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                ViewData["Message"] = "Are You Sure You Want To Delete The Following Option?";
                try
                {
                    Option option = db2.Options.First(o => o.OptionID == ID);
                    return View(option);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for deleting a Option
        [HttpPost, Authorize]
        public ActionResult DeleteOption(Option option)
        {
            using (ShoppingCartDBEntities2 db2 = new ShoppingCartDBEntities2())
            {
                try
                {
                    if (option == null)
                        return RedirectToAction("Error");

                    Option theOption = db2.Options.First(o => o.OptionID == option.OptionID);
                    db2.DeleteObject(theOption);
                    db2.SaveChanges();

                    return RedirectToAction("Options");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Deleting Option: " + GetError(ex);
                    return View("DeleteOption", option);
                }
            }
        }

        // Admin view for listing all Intersections
        [Authorize]
        public ActionResult Intersections(string sortOrder)
        {
            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
            {
                ViewData["Message"] = "Intersections Table:";

                ViewData["PIDSortParm"] = String.IsNullOrEmpty(sortOrder) ? "PID desc" : "";
                ViewData["OIDSortParm"] = (sortOrder == "OID" ? "OID desc" : "OID");

                var interls = from x in db3.Intersections select x;

                switch (sortOrder)
                {
                    case "OID":
                        interls = interls.OrderBy(x => x.OptionID);
                        break;
                    case "OID desc":
                        interls = interls.OrderByDescending(x => x.OptionID);
                        break;
                    case "PID desc":
                        interls = interls.OrderByDescending(x => x.ProductID);
                        break;
                    default:
                        interls = interls.OrderBy(x => x.ProductID);
                        break;
                }
                return View(interls.ToList());
            }
        }

        // Admin view for reviewing an Intersection
        [Authorize]
        public ActionResult IntersectionDetails(int pid, int oid)
        {
            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
            {
                ViewData["Message"] = "Intersection Details:";
                try
                {
                    Intersection inter = db3.Intersections.First(x => x.ProductID == pid && x.OptionID == oid);
                    return View(inter);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for creating a new Intersection
        [Authorize]
        public ActionResult CreateIntersection()
        {
            ViewData["Message"] = "New Intersection:";
            Intersection inter = new Intersection();
            return View(inter);
        }

        // Admin view for creating a new Intersection
        [HttpPost, Authorize]
        public ActionResult CreateIntersection(Intersection inter)
        {
            ViewData["Message"] = "New Intersection:";
            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
            {
                try
                {
                    if (!ModelState.IsValid)
                    {
                        ViewData["Message"] = "Error Creating Intersection:";
                        return View("CreateIntersection", inter);
                    }

                    db3.AddToIntersections(inter);
                    db3.SaveChanges();

                    return RedirectToAction("Intersections");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Creating Intersection: " + GetError(ex);
                    // ViewData["Message"] += "(" + ex.InnerException + ")";
                    return View("CreateIntersection", inter);
                }
            }
        }

        // Admin view for deleting a Intersection
        [Authorize]
        public ActionResult DeleteIntersection(int pid, int oid)
        {
            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
            {
                ViewData["Message"] = "Are You Sure You Want To Delete The Following Intersection?";
                try
                {
                    Intersection inter = db3.Intersections.First(x => x.ProductID == pid && x.OptionID == oid);
                    return View(inter);
                }
                catch
                {
                    return RedirectToAction("Error");
                }
            }
        }

        // Admin view for deleting a Intersection
        [HttpPost, Authorize]
        public ActionResult DeleteIntersection(Intersection inter)
        {
            using (ShoppingCartDBEntities3 db3 = new ShoppingCartDBEntities3())
            {
                try
                {
                    if (inter == null)
                        return RedirectToAction("Error");

                    Intersection theInter = db3.Intersections.First(x => x.ProductID == inter.ProductID &&
                                                                      x.OptionID == inter.OptionID);
                    db3.DeleteObject(theInter);
                    db3.SaveChanges();

                    return RedirectToAction("Intersections");
                }
                catch (Exception ex)
                {
                    ViewData["Message"] = "Error Deleting Intersection: " + GetError(ex);
                    return View("DeleteIntersection", inter);
                }
            }
        }

        // General error message view
        public ActionResult Error()
        {
            ViewData["Message"] = "System Error: Invalid Data";
            return View();
        }

        // Gets the appropriate error message from an exception
        public string GetError(Exception ex)
        {
            if (ex == null || ex.Message == null)
                return "";
            if (ex.Message.ToLower().IndexOf("inner exception") > -1)
            {
                string message = ex.InnerException.ToString();
                int n = -1;
                var match = Regex.Match(message, "\\.\\s");
                if (match.Success)
                {
                    n = match.Index;
                    match = Regex.Match(message.Substring(n + 1), "\\.\\s");
                    if (match.Success)
                        n += match.Index + 1;
                }
                return (n < 1) ? message : message.Substring(0, n + 1);
            }
            return ex.Message;
        }

        // Method for uploading an image file and returns the filepath or an error string
        public string GetFileUpload(HttpPostedFileBase FileUpload, ref Boolean gotError)
        {
            gotError = false;
            string filePath = "";
            if (FileUpload != null && FileUpload.ContentLength > 0)
            {
                string fileName = Path.GetFileName(FileUpload.FileName);
                filePath = Path.Combine(Server.MapPath("/Content/"), fileName);
                try
                {
                    FileUpload.SaveAs(filePath);

                    Bitmap img = new Bitmap(filePath);
                }
                catch (ArgumentException)
                {
                    gotError = true;
                    return "The file uploaded was not an image file";
                }
                catch (Exception err)
                {
                    gotError = true;
                    return GetError(err);
                }
            }
            else if (FileUpload != null && FileUpload.ContentLength == 0)
            {
                gotError = true;
                return "The image file was an empty file";
            }
            return filePath;
        }